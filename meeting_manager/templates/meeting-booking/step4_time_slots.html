<div class="booking-container">
	<!-- Progress Steps -->
	{% include "templates/meeting-booking/_stepper.html" %}

	<!-- Breadcrumb -->
	<div class="breadcrumb-nav">
		<a
			href="/meeting-booking/{{ department.department_slug }}/{{ meeting_type.meeting_slug }}"
			class="breadcrumb-link"
		>
			‚Üê Back to Date Selection
		</a>
	</div>

	<!-- Page Header -->
	<div class="booking-header">
		<h1>Select a Time</h1>
		<p class="text-muted">{{ meeting_type.meeting_name }} on {{ selected_date_display }}</p>
		<p class="timezone-info" id="timezone-display">
			<svg
				width="16"
				height="16"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
			>
				<circle cx="12" cy="12" r="10"></circle>
				<line x1="2" y1="12" x2="22" y2="12"></line>
				<path
					d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
				></path>
			</svg>
			Detecting timezone...
		</p>
	</div>

	<!-- Time Slots Container -->
	<div class="time-slots-container" role="region" aria-label="Available time slots">
		<!-- Loading State with Skeleton -->
		<div id="slots-loading" class="loading-state" role="status" aria-live="polite">
			<p style="margin-bottom: 1rem; color: var(--muted);">Loading available time slots...</p>
			<div class="skeleton-grid" aria-hidden="true">
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
				<div class="skeleton skeleton-slot"></div>
			</div>
		</div>

		<!-- Time Slots Grid -->
		<div id="slots-grid" class="slots-grid" style="display: none" role="list" aria-label="Select a time slot">
			<!-- Time slots will be inserted here by JavaScript -->
		</div>

		<!-- Empty State -->
		<div id="slots-empty" class="empty-state" style="display: none">
			<svg
				width="64"
				height="64"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
			>
				<circle cx="12" cy="12" r="10"></circle>
				<line x1="12" y1="8" x2="12" y2="12"></line>
				<line x1="12" y1="16" x2="12.01" y2="16"></line>
			</svg>
			<h3>No Available Times</h3>
			<p>There are no available time slots for this date. Please select a different date.</p>
			<a
				href="/meeting-booking/{{ department.department_slug }}/{{ meeting_type.meeting_slug }}"
				class="btn-primary"
			>
				Choose Another Date
			</a>
		</div>

		<!-- Error State -->
		<div id="slots-error" class="error-state" style="display: none">
			<svg
				width="48"
				height="48"
				viewBox="0 0 24 24"
				fill="none"
				stroke="currentColor"
				stroke-width="2"
			>
				<circle cx="12" cy="12" r="10"></circle>
				<line x1="12" y1="8" x2="12" y2="12"></line>
				<line x1="12" y1="16" x2="12.01" y2="16"></line>
			</svg>
			<p id="error-message"></p>
			<button onclick="loadTimeSlots()" class="retry-btn">Try Again</button>
		</div>
	</div>

	<!-- Hidden data for JavaScript -->
	<div style="display: none">
		<input type="hidden" id="department-slug" value="{{ department.department_slug }}" />
		<input type="hidden" id="meeting-type-slug" value="{{ meeting_type.meeting_slug }}" />
		<input type="hidden" id="selected-date" value="{{ selected_date }}" />
		<input type="hidden" id="meeting-duration" value="{{ meeting_type.duration }}" />
	</div>
</div>

<style>
	/* Add space between stepper and breadcrumb */
	.breadcrumb-nav {
		margin-top: 1rem;
	}

	/* Reset browser default margins on header elements */
	.booking-header h1 {
		margin-top: 0;
		margin-bottom: 0.15rem;
	}

	.booking-header .text-muted {
		margin-top: 0;
		margin-bottom: 0.1rem;
	}

	/* Time Slots Container */
	.time-slots-container {
		background: var(--card);
		border: 2px solid var(--border);
		border-radius: 16px;
		padding: 1.25rem;
		min-height: 200px;
		box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
	}

	.slots-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
		gap: 0.75rem;
	}

	.time-slot-btn {
		padding: 0.75rem 0.5rem;
		border: 2px solid #ffe8b3;
		border-radius: 8px;
		background: white;
		color: #0f172a;
		font-weight: 600;
		font-size: 0.9rem;
		cursor: pointer;
		transition: all 0.2s;
		text-align: center;
	}

	.time-slot-btn:hover {
		border-color: #e19800 !important;
		background: #fff8e8 !important;
		color: #e19800 !important;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(225, 152, 0, 0.2);
	}

	.time-slot-btn:active {
		transform: translateY(0);
	}

	.time-slot-btn.selected {
		background: #e19800 !important;
		border-color: #e19800 !important;
		color: white !important;
		transform: scale(0.98);
	}

	/* Loading State */
	.loading-state {
		text-align: center;
		padding: 1.5rem 1rem;
	}

	.spinner {
		width: 40px;
		height: 40px;
		border: 3px solid var(--border);
		border-top-color: var(--primary);
		border-radius: 50%;
		animation: spin 1s linear infinite;
		margin: 0 auto 0.75rem;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	.loading-state p {
		color: var(--muted);
		font-size: 0.9rem;
	}

	/* Empty State */
	.empty-state {
		text-align: center;
		padding: 1.5rem 1rem;
	}

	.empty-state svg {
		color: #9ca3af;
		margin-bottom: 1rem;
		width: 48px;
		height: 48px;
	}

	.empty-state h3 {
		font-size: 1.25rem;
		font-weight: 600;
		color: var(--text);
		margin-bottom: 0.35rem;
	}

	.empty-state p {
		color: var(--muted);
		font-size: 0.9rem;
		margin-bottom: 1rem;
	}

	.btn-primary {
		display: inline-block;
		padding: 0.75rem 1.25rem;
		background: var(--primary);
		color: white;
		border-radius: 8px;
		text-decoration: none;
		font-weight: 600;
		transition: all 0.2s;
	}

	.btn-primary:hover {
		background: #c17a00;
		transform: translateY(-1px);
		box-shadow: 0 4px 12px rgba(225, 152, 0, 0.2);
	}

	/* Error State */
	.error-state {
		text-align: center;
		padding: 1.5rem 1rem;
	}

	.error-state svg {
		color: #ef4444;
		margin-bottom: 0.75rem;
		width: 40px;
		height: 40px;
	}

	.error-state p {
		color: var(--muted);
		font-size: 0.9rem;
		margin-bottom: 1rem;
	}

	.retry-btn {
		background: var(--primary);
		color: white;
		border: none;
		padding: 0.65rem 1.25rem;
		border-radius: 8px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
	}

	.retry-btn:hover {
		background: #c17a00;
		transform: translateY(-1px);
		box-shadow: 0 4px 12px rgba(225, 152, 0, 0.2);
	}

	/* Mobile */
	@media (max-width: 768px) {
		.time-slots-container {
			padding: 1rem;
			border-radius: 12px;
			min-height: 160px;
		}

		.slots-grid {
			grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
			gap: 0.5rem;
		}

		.time-slot-btn {
			padding: 0.65rem 0.35rem;
			font-size: 0.8rem;
		}

		.loading-state,
		.empty-state,
		.error-state {
			padding: 1rem;
		}
	}
</style>

<script>
	// Get hidden values
	const departmentSlug = document.getElementById("department-slug").value;
	const meetingTypeSlug = document.getElementById("meeting-type-slug").value;
	const selectedDate = document.getElementById("selected-date").value;
	const meetingDuration = document.getElementById("meeting-duration").value;

	// Elements
	const timezoneDisplay = document.getElementById("timezone-display");
	const slotsLoading = document.getElementById("slots-loading");
	const slotsGrid = document.getElementById("slots-grid");
	const slotsEmpty = document.getElementById("slots-empty");
	const slotsError = document.getElementById("slots-error");
	const errorMessage = document.getElementById("error-message");

	// Detect visitor timezone
	let visitorTimezone = "UTC";
	function detectTimezone() {
		try {
			visitorTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
			timezoneDisplay.innerHTML = `
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="12" cy="12" r="10"></circle>
					<line x1="2" y1="12" x2="22" y2="12"></line>
					<path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
				</svg>
				Times shown in ${visitorTimezone}
			`;
		} catch (e) {
			console.error("Could not detect timezone:", e);
			visitorTimezone = "UTC";
			timezoneDisplay.textContent = "Times shown in UTC";
		}
	}

	// Time slots data
	let timeSlots = [];

	// Initialize
	detectTimezone();
	loadTimeSlots();

	// Load time slots from API
	function loadTimeSlots() {
		// Show loading state
		slotsLoading.style.display = "block";
		slotsGrid.style.display = "none";
		slotsEmpty.style.display = "none";
		slotsError.style.display = "none";

		frappe.call({
			method: "meeting_manager.meeting_manager.api.public.get_available_slots",
			args: {
				department_slug: departmentSlug,
				meeting_type_slug: meetingTypeSlug,
				date: selectedDate,
				visitor_timezone: visitorTimezone,
			},
			callback: function (r) {
				if (r.message && r.message.success) {
					timeSlots = r.message.slots || [];
					if (timeSlots.length > 0) {
						renderTimeSlots();
					} else {
						showEmpty();
					}
				} else {
					showError(r.message?.message || "Failed to load time slots");
				}
			},
			error: function (err) {
				console.error("Error loading time slots:", err);
				showError("An error occurred while loading time slots");
			},
		});
	}

	// Render time slots
	function renderTimeSlots() {
		slotsGrid.innerHTML = "";

		timeSlots.forEach((slot) => {
			const slotBtn = document.createElement("button");
			slotBtn.className = "time-slot-btn";
			slotBtn.setAttribute("role", "listitem");
			slotBtn.setAttribute("aria-label", `Book time slot from ${slot.start_time} to ${slot.end_time}`);
			// Display just the start_time - end_time in clean format
			slotBtn.textContent = `${slot.start_time} - ${slot.end_time}`;
			slotBtn.addEventListener("click", () => {
				// Show selected state briefly before navigation
				slotBtn.classList.add("selected");
				slotBtn.setAttribute("aria-pressed", "true");
				setTimeout(() => {
					window.location.href = `/meeting-booking/${departmentSlug}/${meetingTypeSlug}/${selectedDate}/${slot.start_time}`;
				}, 150);
			});
			slotsGrid.appendChild(slotBtn);
		});

		// Show grid
		slotsLoading.style.display = "none";
		slotsGrid.style.display = "grid";
	}

	// Show empty state
	function showEmpty() {
		slotsLoading.style.display = "none";
		slotsGrid.style.display = "none";
		slotsEmpty.style.display = "block";
	}

	// Show error
	function showError(message) {
		errorMessage.textContent = message;
		slotsLoading.style.display = "none";
		slotsGrid.style.display = "none";
		slotsError.style.display = "block";
	}
</script>
