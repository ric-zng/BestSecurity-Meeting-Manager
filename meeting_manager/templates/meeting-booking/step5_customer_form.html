<div class="booking-container">
	<!-- Progress Steps -->
	{% include "templates/meeting-booking/_stepper.html" %}

	<!-- Breadcrumb -->
	<div class="breadcrumb-nav">
		<a
			href="/meeting-booking/{{ department.department_slug }}/{{ meeting_type.meeting_slug }}/{{ selected_date }}"
			class="breadcrumb-link"
		>
			‚Üê Back to Time Slots
		</a>
	</div>

	<!-- Page Header -->
	<div class="booking-header">
		<h1>Enter Your Details</h1>
		<p class="text-muted">Almost done! Just need a few details to confirm your booking</p>
	</div>

	<!-- Form Container -->
	<div class="form-container">
		<!-- Booking Summary -->
		<div class="booking-summary">
			<h3>Booking Summary</h3>
			<div class="summary-item">
				<svg
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
					<line x1="16" y1="2" x2="16" y2="6"></line>
					<line x1="8" y1="2" x2="8" y2="6"></line>
					<line x1="3" y1="10" x2="21" y2="10"></line>
				</svg>
				<div>
					<strong>{{ selected_date_display }}</strong>
					<span class="text-muted">at {{ selected_time_display }}</span>
				</div>
			</div>
			<div class="summary-item">
				<svg
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<circle cx="12" cy="12" r="10"></circle>
					<polyline points="12 6 12 12 16 14"></polyline>
				</svg>
				<div>
					<strong>{{ meeting_type.meeting_name }}</strong>
					<span class="text-muted">{{ meeting_type.duration }} minutes</span>
				</div>
			</div>
			<div class="summary-item">
				<svg
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
					<circle cx="9" cy="7" r="4"></circle>
					<path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
					<path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
				</svg>
				<div>
					<strong>{{ department.department_name }}</strong>
				</div>
			</div>
		</div>

		<!-- Customer Form -->
		<form id="booking-form" class="customer-form" novalidate>
			<div class="form-group">
				<label for="customer_name">Full Name <span class="required">*</span></label>
				<input
					type="text"
					id="customer_name"
					name="customer_name"
					class="form-control"
					placeholder="John Doe"
					autocomplete="name"
					aria-describedby="customer_name-error"
					aria-required="true"
				/>
				<span class="field-error" id="customer_name-error" role="alert"></span>
			</div>

			<div class="form-group">
				<label for="customer_email">Email Address <span class="required">*</span></label>
				<input
					type="email"
					id="customer_email"
					name="customer_email"
					class="form-control"
					placeholder="john@example.com"
					autocomplete="email"
					aria-describedby="customer_email-error"
				/>
				<span class="field-error" id="customer_email-error" role="alert"></span>
			</div>

			<div class="form-group">
				<label for="customer_phone">Phone Number <span class="required">*</span></label>
				<input
					type="tel"
					id="customer_phone"
					name="customer_phone"
					class="form-control"
					placeholder="+254 712 345678"
					autocomplete="tel"
					aria-describedby="customer_phone-error"
					aria-required="true"
				/>
				<span class="field-error" id="customer_phone-error" role="alert"></span>
			</div>

			<div class="form-group">
				<label for="customer_notes">Additional Notes (Optional)</label>
				<textarea
					id="customer_notes"
					name="customer_notes"
					class="form-control"
					rows="4"
					placeholder="Any special requirements or topics you'd like to discuss?"
				></textarea>
			</div>

			<!-- Error Message -->
			<div class="alert alert-danger" id="error-message" style="display: none">
				<svg
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<circle cx="12" cy="12" r="10"></circle>
					<line x1="12" y1="8" x2="12" y2="12"></line>
					<line x1="12" y1="16" x2="12.01" y2="16"></line>
				</svg>
				<span id="error-text"></span>
			</div>

			<!-- Submit Button -->
			<button type="submit" class="btn-submit" id="submit-btn">
				<span class="btn-text">Confirm Booking</span>
				<span class="btn-spinner" style="display: none">
					<div class="spinner-small"></div>
					Processing...
				</span>
			</button>

			<p class="form-note">
				By confirming, you agree to receive booking confirmation and reminders via email.
			</p>
		</form>
	</div>

	<!-- Hidden data for JavaScript -->
	<div style="display: none">
		<input type="hidden" id="department-slug" value="{{ department.department_slug }}" />
		<input type="hidden" id="meeting-type-slug" value="{{ meeting_type.meeting_slug }}" />
		<input type="hidden" id="selected-date" value="{{ selected_date }}" />
		<input type="hidden" id="selected-time" value="{{ selected_time }}" />
	</div>
</div>

<style>
	/* Form Container */
	.form-container {
		display: grid;
		grid-template-columns: 350px 1fr;
		gap: 2rem;
	}

	/* Booking Summary */
	.booking-summary {
		background: var(--primary-soft);
		border: 2px solid var(--border);
		border-radius: 20px;
		padding: 1.5rem;
		height: fit-content;
		box-shadow: 0 40px 80px rgba(15, 23, 42, 0.1);
	}

	.booking-summary h3 {
		font-size: 1.125rem;
		font-weight: 600;
		color: var(--text);
		margin-bottom: 1.25rem;
	}

	.summary-item {
		display: flex;
		gap: 1rem;
		padding: 1rem 0;
		border-bottom: 1px solid var(--border);
	}

	.summary-item:last-child {
		border-bottom: none;
	}

	.summary-item svg {
		flex-shrink: 0;
		color: var(--primary);
	}

	.summary-item strong {
		display: block;
		color: var(--text);
		margin-bottom: 0.25rem;
	}

	.summary-item .text-muted {
		color: var(--muted);
		font-size: 0.875rem;
	}

	/* Customer Form */
	.customer-form {
		background: var(--card);
		border: 2px solid var(--border);
		border-radius: 20px;
		padding: 2rem;
		box-shadow: 0 40px 80px rgba(15, 23, 42, 0.1);
	}

	.form-group {
		margin-bottom: 1.5rem;
	}

	.form-group label {
		display: block;
		font-weight: 500;
		color: var(--text);
		margin-bottom: 0.5rem;
		font-size: 0.9rem;
	}

	.required {
		color: #ef4444;
	}

	.form-control {
		width: 100%;
		padding: 1rem 1rem;
		border: 2px solid var(--border);
		border-radius: 8px;
		font-size: 1rem;
		transition: all 0.2s;
		font-family: inherit;
		background: white;
		color: var(--text);
	}

	.form-control:focus {
		outline: none;
		border-color: var(--primary);
		box-shadow: 0 0 0 3px rgba(225, 152, 0, 0.1);
	}

	/* Validation States */
	.form-control.valid {
		border-color: #22c55e;
	}

	.form-control.valid:focus {
		border-color: #22c55e;
		box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
	}

	.form-control.invalid {
		border-color: #ef4444;
	}

	.form-control.invalid:focus {
		border-color: #ef4444;
		box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
	}

	.field-error {
		display: block;
		color: #ef4444;
		font-size: 0.8rem;
		margin-top: 0.375rem;
		min-height: 1.2em;
	}

	textarea.form-control {
		resize: vertical;
		min-height: 100px;
	}

	/* Alert */
	.alert {
		padding: 1rem;
		border-radius: 8px;
		margin-bottom: 1.5rem;
		display: flex;
		align-items: start;
		gap: 0.75rem;
	}

	.alert-danger {
		background: #fef2f2;
		color: #991b1b;
		border: 1px solid #fecaca;
	}

	.alert svg {
		flex-shrink: 0;
		margin-top: 0.125rem;
	}

	/* Submit Button */
	.btn-submit {
		width: 100%;
		padding: 1rem 2rem;
		background: var(--primary);
		color: white;
		border: none;
		border-radius: 8px;
		font-size: 1.125rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
		position: relative;
	}

	.btn-submit:hover:not(:disabled) {
		background: #c17a00;
		transform: translateY(-1px);
		box-shadow: 0 4px 12px rgba(225, 152, 0, 0.2);
	}

	.btn-submit:disabled {
		opacity: 0.7;
		cursor: not-allowed;
	}

	.btn-spinner {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.75rem;
	}

	.spinner-small {
		width: 20px;
		height: 20px;
		border: 3px solid rgba(255, 255, 255, 0.3);
		border-top-color: white;
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	@keyframes spin {
		to {
			transform: rotate(360deg);
		}
	}

	.form-note {
		text-align: center;
		color: var(--muted);
		font-size: 0.875rem;
		margin-top: 1rem;
		margin-bottom: 0;
	}

	/* Mobile */
	@media (max-width: 768px) {
		.form-container {
			grid-template-columns: 1fr;
		}

		.booking-summary {
			order: 2;
		}

		.customer-form {
			order: 1;
			padding: 1.5rem;
		}

		.progress-steps {
			flex-direction: column;
			gap: 2rem;
		}

		.progress-steps::before {
			display: none;
		}

		.progress-step {
			width: auto;
		}

		.step-label {
			font-size: 0.75rem;
		}

		.step-number {
			width: 40px;
			height: 40px;
			font-size: 0.875rem;
		}

		.booking-header h1 {
			font-size: 1.5rem;
		}
	}
</style>

<script>
	// Get hidden values
	const departmentSlug = document.getElementById("department-slug").value;
	const meetingTypeSlug = document.getElementById("meeting-type-slug").value;
	const selectedDate = document.getElementById("selected-date").value;
	const selectedTime = document.getElementById("selected-time").value;

	// Elements
	const bookingForm = document.getElementById("booking-form");
	const submitBtn = document.getElementById("submit-btn");
	const btnText = submitBtn.querySelector(".btn-text");
	const btnSpinner = submitBtn.querySelector(".btn-spinner");
	const errorMessage = document.getElementById("error-message");
	const errorText = document.getElementById("error-text");

	// Form fields
	const nameInput = document.getElementById("customer_name");
	const emailInput = document.getElementById("customer_email");
	const phoneInput = document.getElementById("customer_phone");

	// Validation patterns
	const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	const phoneRegex = /^[\d\s\-\+\(\)]{7,20}$/;

	// Detect visitor timezone
	let visitorTimezone = "UTC";
	try {
		visitorTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
	} catch (e) {
		console.error("Could not detect timezone:", e);
	}

	// Pre-fill form from URL parameters (e.g., from Support Dashboard)
	function prefillFromURLParams() {
		const urlParams = new URLSearchParams(window.location.search);

		if (urlParams.has('customer_name')) {
			const name = urlParams.get('customer_name');
			if (name) {
				nameInput.value = name;
			}
		}

		if (urlParams.has('customer_email')) {
			const email = urlParams.get('customer_email');
			if (email) {
				emailInput.value = email;
			}
		}

		if (urlParams.has('customer_phone')) {
			const phone = urlParams.get('customer_phone');
			if (phone) {
				phoneInput.value = phone;
			}
		}
	}

	// Run pre-fill on page load
	prefillFromURLParams();

	// Validation functions
	function validateName(value) {
		const trimmed = value.trim();
		if (!trimmed) {
			return { valid: false, message: "Full name is required" };
		}
		if (trimmed.length < 2) {
			return { valid: false, message: "Name must be at least 2 characters" };
		}
		if (trimmed.length > 100) {
			return { valid: false, message: "Name must be less than 100 characters" };
		}
		return { valid: true, message: "" };
	}

	function validateEmail(value) {
		const trimmed = value.trim();
		if (!trimmed) {
			return { valid: false, message: "Email address is required" };
		}
		if (!emailRegex.test(trimmed)) {
			return { valid: false, message: "Please enter a valid email address" };
		}
		return { valid: true, message: "" };
	}

	function validatePhone(value) {
		const trimmed = value.trim();
		if (!trimmed) {
			return { valid: false, message: "Phone number is required" };
		}
		if (!phoneRegex.test(trimmed)) {
			return { valid: false, message: "Please enter a valid phone number" };
		}
		return { valid: true, message: "" };
	}

	// Update field state
	function updateFieldState(input, result) {
		const errorSpan = document.getElementById(`${input.id}-error`);

		input.classList.remove("valid", "invalid");

		if (result.valid) {
			input.classList.add("valid");
			errorSpan.textContent = "";
		} else {
			input.classList.add("invalid");
			errorSpan.textContent = result.message;
		}

		return result.valid;
	}

	// Clear field state (for when field is empty and hasn't been touched)
	function clearFieldState(input) {
		const errorSpan = document.getElementById(`${input.id}-error`);
		input.classList.remove("valid", "invalid");
		errorSpan.textContent = "";
	}

	// Track if fields have been touched
	const touched = {
		customer_name: false,
		customer_email: false,
		customer_phone: false
	};

	// Add event listeners for real-time validation
	nameInput.addEventListener("blur", function() {
		touched.customer_name = true;
		updateFieldState(nameInput, validateName(nameInput.value));
	});

	nameInput.addEventListener("input", function() {
		if (touched.customer_name) {
			updateFieldState(nameInput, validateName(nameInput.value));
		}
	});

	emailInput.addEventListener("blur", function() {
		touched.customer_email = true;
		updateFieldState(emailInput, validateEmail(emailInput.value));
	});

	emailInput.addEventListener("input", function() {
		if (touched.customer_email) {
			updateFieldState(emailInput, validateEmail(emailInput.value));
		}
	});

	phoneInput.addEventListener("blur", function() {
		touched.customer_phone = true;
		updateFieldState(phoneInput, validatePhone(phoneInput.value));
	});

	phoneInput.addEventListener("input", function() {
		if (touched.customer_phone) {
			updateFieldState(phoneInput, validatePhone(phoneInput.value));
		}
	});

	// Validate all fields
	function validateAll() {
		// Mark all as touched
		touched.customer_name = true;
		touched.customer_email = true;
		touched.customer_phone = true;

		const nameValid = updateFieldState(nameInput, validateName(nameInput.value));
		const emailValid = updateFieldState(emailInput, validateEmail(emailInput.value));
		const phoneValid = updateFieldState(phoneInput, validatePhone(phoneInput.value));

		return nameValid && emailValid && phoneValid;
	}

	// Handle form submission
	bookingForm.addEventListener("submit", function (e) {
		e.preventDefault();

		// Validate all fields
		if (!validateAll()) {
			// Focus first invalid field
			const firstInvalid = bookingForm.querySelector(".form-control.invalid");
			if (firstInvalid) {
				firstInvalid.focus();
			}
			return;
		}

		// Get form data
		const formData = {
			department_slug: departmentSlug,
			meeting_type_slug: meetingTypeSlug,
			scheduled_date: selectedDate,
			scheduled_start_time: selectedTime,
			customer_name: nameInput.value.trim(),
			customer_email: emailInput.value.trim(),
			customer_phone: phoneInput.value.trim(),
			customer_notes: document.getElementById("customer_notes").value.trim(),
			visitor_timezone: visitorTimezone,
		};

		// Show loading state
		submitBtn.disabled = true;
		btnText.style.display = "none";
		btnSpinner.style.display = "flex";
		errorMessage.style.display = "none";

		// Submit booking
		frappe.call({
			method: "meeting_manager.meeting_manager.api.public.create_customer_booking",
			type: "POST",
			args: {
				booking_data: formData,
			},
			callback: function (r) {
				if (r.message && r.message.success) {
					// Success! Redirect to confirmation page
					window.location.href = `/booking-confirmation?booking_id=${r.message.booking_id}`;
				} else {
					// Show error
					showError(r.message?.message || "Failed to create booking. Please try again.");
					submitBtn.disabled = false;
					btnText.style.display = "inline";
					btnSpinner.style.display = "none";
				}
			},
			error: function (err) {
				console.error("Booking error:", err);
				showError(err.message || "An error occurred. Please try again.");
				submitBtn.disabled = false;
				btnText.style.display = "inline";
				btnSpinner.style.display = "none";
			},
		});
	});

	// Show error message
	function showError(message) {
		errorText.textContent = message;
		errorMessage.style.display = "flex";
		errorMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
	}
</script>
